{%- comment -%}
  Cite / Share menu for publications.
  - Uses a <details> disclosure (no Bootstrap dropdown dependency).
  - Embeds a JSON payload the JS can read to copy/export/share.
{%- endcomment -%}

{%- assign ui = site.data.i18n[page.lang] | default: site.data.i18n.en -%}

{%- assign canonical_url = site.url | append: page.url | append: '#' | append: entry.key -%}
{%- assign note_down = entry.note | default: '' | downcase -%}
{%- assign is_published_or_preprint = false -%}
{%- if note_down contains 'published' or note_down contains 'posted' -%}
  {%- assign is_published_or_preprint = true -%}
{%- endif -%}
{%- if entry.arxiv -%}
  {%- assign is_published_or_preprint = true -%}
{%- endif -%}

{%- if is_published_or_preprint -%}
  {%- capture author_plain -%}
    {%- for a in entry.author_array -%}
      {%- if forloop.first == false -%}; {%- endif -%}
      {{- a.first }} {{ a.last -}}
    {%- endfor -%}
  {%- endcapture -%}
  {%- assign author_plain = author_plain | strip -%}

  {%- capture ris -%}
    {%- if entry.type == 'article' -%}
TY  - JOUR
    {%- else -%}
TY  - GEN
    {%- endif -%}
    {%- for a in entry.author_array -%}
AU  - {{ a.first }} {{ a.last }}
    {%- endfor -%}
TI  - {{ entry.title | strip }}
    {%- if entry.journal -%}
JO  - {{ entry.journal | strip }}
    {%- elsif entry.booktitle -%}
T2  - {{ entry.booktitle | strip }}
    {%- endif -%}
PY  - {{ entry.year | strip }}
    {%- if entry.doi -%}
DO  - {{ entry.doi | strip }}
    {%- endif -%}
    {%- if entry.url -%}
UR  - {{ entry.url | strip }}
    {%- endif -%}
ER  -
  {%- endcapture -%}
  {%- assign ris = ris | strip -%}

  {%- capture citation_plain -%}
    {{- author_plain -}}
    {%- if entry.year -%} ({{ entry.year | strip }}).{%- endif -%}
    {{- ' ' -}}{{ entry.title | strip }}.
    {%- if entry.journal -%} {{ entry.journal | strip }}.{%- endif -%}
    {%- if entry.doi -%} https://doi.org/{{ entry.doi | strip }}{%- endif -%}
    {%- if entry.doi == blank and entry.url -%} {{ entry.url | strip }}{%- endif -%}
  {%- endcapture -%}
  {%- assign citation_plain = citation_plain | strip -%}

  {%- capture payload -%}
{
  "key": {{ entry.key | jsonify }},
  "canonical_url": {{ canonical_url | jsonify }},
  "title": {{ entry.title | strip | jsonify }},
  "authors": {{ author_plain | jsonify }},
  "year": {{ entry.year | default: '' | strip | jsonify }},
  "doi": {{ entry.doi | default: '' | strip | jsonify }},
  "url": {{ entry.url | default: '' | strip | jsonify }},
  "note": {{ entry.note | default: '' | strip | jsonify }},
  "citation_plain": {{ citation_plain | jsonify }},
  "bibtex": {{ entry.bibtex | jsonify }},
  "ris": {{ ris | jsonify }},
  "csl_json": {
    "id": {{ entry.key | jsonify }},
    "type": {%- if entry.type == 'article' -%}"article-journal"{%- else -%}"report"{%- endif -%},
    "title": {{ entry.title | strip | jsonify }},
    "author": [
      {%- for a in entry.author_array -%}
        {
          "family": {{ a.last | jsonify }},
          "given": {{ a.first | jsonify }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ],
    "issued": { "date-parts": [[{{ entry.year | default: 0 | plus: 0 }}]] },
    "container-title": {{ entry.journal | default: entry.booktitle | default: '' | strip | jsonify }},
    "DOI": {{ entry.doi | default: '' | strip | jsonify }},
    "URL": {{ entry.url | default: '' | strip | jsonify }}
  }
}
  {%- endcapture -%}

  <details class="cite-share" data-cite-share-key="{{ entry.key }}">
    <summary class="btn btn-sm z-depth-0 cite-share__summary" role="button" aria-label="Cite and share menu">
      <span class="cite-share__summary-label">
        <i class="ti ti-quote"></i>
        {{ ui.cite_share.label }}
      </span>
      <i class="ti ti-chevron-down cite-share__chev"></i>
    </summary>
    <div class="cite-share__panel" role="group" aria-label="Cite and share actions">
      <div class="cite-share__section">
        <div class="cite-share__section-title">{{ ui.cite_share.export }}</div>
        <div class="cite-share__grid">
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_citation">
            <i class="ti ti-copy"></i> {{ ui.cite_share.copy_citation }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_link">
            <i class="ti ti-link"></i> {{ ui.cite_share.copy_link }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_bibtex">
            <i class="ti ti-braces"></i> {{ ui.cite_share.copy_bibtex }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="download_bibtex">
            <i class="ti ti-download"></i> {{ ui.cite_share.download_bibtex }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_ris">
            <i class="ti ti-file-text"></i> {{ ui.cite_share.copy_ris }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="download_ris">
            <i class="ti ti-download"></i> {{ ui.cite_share.download_ris }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_csl_json">
            <i class="ti ti-code"></i> {{ ui.cite_share.copy_csl_json }}
          </button>
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="download_csl_json">
            <i class="ti ti-download"></i> {{ ui.cite_share.download_csl_json }}
          </button>
        </div>
      </div>

      <div class="cite-share__section">
        <div class="cite-share__section-title">{{ ui.cite_share.share }}</div>
        <div class="cite-share__grid cite-share__grid--share">
          <button class="btn btn-sm z-depth-0 cite-share__btn" type="button" data-cite-share-action="copy_share_text">
            <i class="ti ti-share-2"></i> {{ ui.cite_share.copy_share_text }}
          </button>
          <a
            class="btn btn-sm z-depth-0 cite-share__btn"
            href="https://twitter.com/intent/tweet?text={{ citation_plain | uri_escape }}&url={{ canonical_url | uri_escape }}"
            target="_blank"
            rel="noopener"
          >
            <i class="ti ti-brand-x"></i> X
          </a>
          <a
            class="btn btn-sm z-depth-0 cite-share__btn"
            href="https://www.linkedin.com/sharing/share-offsite/?url={{ canonical_url | uri_escape }}"
            target="_blank"
            rel="noopener"
          >
            <i class="ti ti-brand-linkedin"></i> LinkedIn
          </a>
        </div>
        <div class="cite-share__hint">
          {{ ui.cite_share.tip }}
        </div>
      </div>
    </div>
    <script type="application/json" class="cite-share__data">{{ payload | strip }}</script>
  </details>
{%- endif -%}
