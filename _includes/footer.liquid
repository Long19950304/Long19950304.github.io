{% capture footer_contents %}
  &copy; Copyright {{ site.time | date: '%Y' }}
  {{ site.first_name }}
  {{ site.middle_name }}
  {{ site.last_name }}. {{ site.footer_text }}
  <span id="site-visit-badge" class="ms-2">
    {% if page.url contains '/zh/' %}访问{% else %}Visits{% endif %}:
    <span id="site-visit-count">189</span>
  </span>
  {% if site.impressum_path %}
    <a href="{{ site.url }}{{ site.baseurl }}{{ site.impressum_path }}">Impressum</a>.
  {% endif %}
  {% if site.last_updated %}
    Last updated: {{ 'now' | date: '%B %d, %Y' }}.
  {% endif %}
{% endcapture %}

{% if site.footer_fixed %}
  <footer class="fixed-bottom" role="contentinfo">
    <div class="container mt-0">
      {{ footer_contents }}
    </div>
  </footer>
{% else %}
  <footer class="sticky-bottom mt-5" role="contentinfo">
    {% if site.newsletter.enabled %}
      {% include newsletter.liquid %}
    {% endif %}

    <div class="container">
      {{ footer_contents }}
    </div>
  </footer>
{% endif %}

<script>
  // Simple public counter (static site-friendly).
  // Note: counts 1 per browser session (sessionStorage), not per page navigation.
  (function () {
    const el = document.getElementById('site-visit-count');
    if (!el) return;

    const DEFAULT = 189;
    // Counter namespace:
    // - We now use the new domain for increments.
    // - To preserve the historical count, we keep a one-time baseline from the old namespace.
    const NS_NEW = 'www.zhaozhilong.com';
    const NS_OLD = 'long19950304.github.io';
    const NAME = 'site_visits';
    const BASE = 'https://api.counterapi.dev/v1';
    const countedKey = 'zz_site_visit_counted_v1';
    const baselineKey = 'zz_site_visit_baseline_v1';

    // Avoid inflating counts when previewing locally.
    const isProd = window.location && ['www.zhaozhilong.com', 'zhaozhilong.com', 'long19950304.github.io'].includes(window.location.hostname);
    const hasCounted = !!(window.sessionStorage && sessionStorage.getItem(countedKey));
    const endpointNew = hasCounted || !isProd
      ? `${BASE}/${NS_NEW}/${NAME}/`
      : `${BASE}/${NS_NEW}/${NAME}/up`;

    function readBaseline() {
      try {
        const v = window.localStorage && localStorage.getItem(baselineKey);
        const n = v ? Number(v) : NaN;
        return Number.isFinite(n) ? n : null;
      } catch (_) {
        return null;
      }
    }

    function writeBaseline(v) {
      try { localStorage.setItem(baselineKey, String(v)); } catch (_) {}
    }

    function setCount(base, n) {
      const total = (Number.isFinite(base) ? base : DEFAULT) + (Number.isFinite(n) ? n : 0);
      el.textContent = total.toLocaleString();
    }

    const baseline = readBaseline();
    const baselinePromise = baseline != null
      ? Promise.resolve(baseline)
      : fetch(`${BASE}/${NS_OLD}/${NAME}/`, { method: 'GET' })
          .then(r => r.json())
          .then(d => {
            const v = (d && typeof d.count === 'number') ? d.count : DEFAULT;
            writeBaseline(v);
            return v;
          })
          .catch(() => DEFAULT);

    Promise.all([
      baselinePromise,
      fetch(endpointNew, { method: 'GET' })
        .then(r => r.json())
        .then(d => (d && typeof d.count === 'number') ? d.count : 0)
        .catch(() => 0),
    ])
      .then(([base, n]) => {
        setCount(base, n);
        try { sessionStorage.setItem(countedKey, '1'); } catch (_) {}
      })
      .catch(() => {
        el.textContent = DEFAULT.toLocaleString();
      });
  })();
</script>
